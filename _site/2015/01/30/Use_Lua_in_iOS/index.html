<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Write The Code, Change The World!">

    <title>如何在iOS中调用Lua - DevShen Blog</title>

    <link rel="canonical" href="http://devshen.github.io/2015/01/30/Use_Lua_in_iOS/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">DevShen Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/post-bg-01.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>如何在iOS中调用Lua</h1>
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by Shen Quan on January 30, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1>如何在iOS中调用Lua</h1>

<p>最近接触了Lua脚本语言，对iOS来说是个好东西，它可以以脚本形式调用iOS应用中你所写的函数，这使得在不升级应用的情况下改变内部业务逻辑成为可能，相关的框架在网上能搜索到，<a href="https://github.com/probablycorey/wax"><strong>Wax</strong></a>是比较有名气的，不过目前已经无人维护，其实，你也可以自己对Lua进行封装。</p>

<p>封装的事，以后再说，对于没接触过Lua的iOS同行来说，对Lua是如何在iOS中运行可能还没有概念，下面我将以一个例子来讲下Lua的iOS调用基本原理</p>

<h2>初始化实例应用</h2>

<p>首先新建个工程</p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/CreateNewProject.png" alt=""></p>

<p>再创建一个继承于<code>UIView</code>的新类<code>CubeView</code></p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/CreateNewFile.png" alt=""></p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/CreateNewFileWithUIView.png" alt=""></p>

<p>在<code>CubeView.h</code>中输入以下代码:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="o">:</span> <span class="bp">NSUInteger</span> <span class="p">{</span>
    <span class="n">DirectionUp</span><span class="p">,</span>
    <span class="n">DirectionDown</span><span class="p">,</span>
    <span class="n">DirectionLeft</span><span class="p">,</span>
    <span class="n">DirectionRight</span>
<span class="p">}</span> <span class="n">Direction</span><span class="p">;</span>

<span class="k">@interface</span> <span class="nc">CubeView</span> : <span class="bp">UIView</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">cubeSpeed</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithFrame:</span><span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nv">frame</span> <span class="nf">Speed:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nv">speed</span> <span class="nf">Name:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">name</span><span class="p">;</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">goDirection:</span><span class="p">(</span><span class="n">Direction</span><span class="p">)</span><span class="nv">direction</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div>
<p>在<code>CubeView.m</code>输入以下代码:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#import &quot;CubeView.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">CubeView</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithFrame:</span><span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nv">frame</span> <span class="nf">Speed:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nv">speed</span> <span class="nf">Name:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">name</span><span class="p">;</span>
<span class="p">{</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">setFrame</span><span class="p">:</span><span class="n">frame</span><span class="p">];</span>
        <span class="n">cubeSpeed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">goDirection</span><span class="p">:(</span><span class="n">Direction</span><span class="p">)</span><span class="n">direction</span>
<span class="p">{</span>
    <span class="bp">CGPoint</span> <span class="n">newPoint</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">center</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">DirectionUp</span><span class="p">:</span>
            <span class="n">newPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="n">cubeSpeed</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">DirectionDown</span><span class="p">:</span>
            <span class="n">newPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">cubeSpeed</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">DirectionLeft</span><span class="p">:</span>
            <span class="n">newPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">cubeSpeed</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">DirectionRight</span><span class="p">:</span>
            <span class="n">newPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">cubeSpeed</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">setCenter</span><span class="p">:</span><span class="n">newPoint</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>代码很简单，就是创建了一个<code>CubeView</code>类，其拥有<code>speed</code>属性和<code>name</code>属性，通过<code>goDirection:</code>方法改变View的位置.</p>

<p>然后在<code>ViewController.m</code>文件中输入:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#import &quot;ViewController.h&quot;</span>
<span class="cp">#import &quot;CubeView.h&quot;</span>

<span class="n">CubeView</span> <span class="o">*</span><span class="n">cubeTarget</span><span class="p">;</span>

<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">strong</span><span class="p">)</span><span class="bp">NSTimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>

    <span class="n">cubeTarget</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CubeView</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFrame</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
                                               <span class="nl">Speed</span><span class="p">:</span><span class="mi">10</span>
                                                <span class="nl">Name</span><span class="p">:</span><span class="s">@&quot;Target&quot;</span><span class="p">];</span>
    <span class="p">[</span><span class="n">cubeTarget</span> <span class="nl">setBackgroundColor</span><span class="p">:[</span><span class="bp">UIColor</span> <span class="n">purpleColor</span><span class="p">]];</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">cubeTarget</span><span class="p">];</span>

    <span class="nb">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSTimer</span> <span class="nl">scheduledTimerWithTimeInterval</span><span class="p">:</span><span class="mf">1.0</span>
                                                  <span class="nl">target</span><span class="p">:</span><span class="nb">self</span>
                                                <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">runLoop</span><span class="p">:)</span>
                                                <span class="nl">userInfo</span><span class="p">:</span><span class="nb">nil</span>
                                                 <span class="nl">repeats</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">runLoop:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">cubeTarget</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionDown</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@‘s center is on %@&quot;</span><span class="p">,</span><span class="n">cubeTarget</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="n">NSStringFromCGPoint</span><span class="p">(</span><span class="n">cubeTarget</span><span class="p">.</span><span class="n">center</span><span class="p">));</span>

<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didReceiveMemoryWarning</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">didReceiveMemoryWarning</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>代码初始化一个<code>CubeView</code>实例，给了初始的位置和speed，并开启一个定时器，每隔1秒将<code>cubeTarget</code>往界面下方移动，运行代码，能看到如下输出:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">2015-01-30 23:40:24.568 DVSLua[14694:2319079] Target‘s center is on {130, 120}
2015-01-30 23:40:25.564 DVSLua[14694:2319079] Target‘s center is on {130, 130}
2015-01-30 23:40:26.564 DVSLua[14694:2319079] Target‘s center is on {130, 140}
2015-01-30 23:40:27.563 DVSLua[14694:2319079] Target‘s center is on {130, 150}
</code></pre></div>
<p>好，这样前期的准备工作就完成了。</p>

<h2>Lua导入到应用</h2>

<p>现在准备将<strong>Lua</strong>嵌入到工程中</p>

<p>1.首先，需要获取Lua源码<a href="http://www.lua.org/ftp/lua-5.1-tar.gz">LuaResource</a>，本篇博文使用的是Lua5.1版本，5.2的版本改变了函数注册的方式，不适配本博文的代码。</p>

<p>2.下载后的文件解压后会看到名为<code>src</code>的文件夹，里面就是我们需要的，将<code>src</code>文件夹改名为<code>lua</code>，删除其中的<code>MakeFile</code>、<code>lua.c</code>、<code>luac.c</code>文件，将<code>lua</code>文件夹拖到工程中，记住不要选择<code>create external build system box</code></p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/ImportLua-1.png" alt=""></p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/ImportLua-2.png" alt=""></p>

<p>这样Lua就嵌入到工程中了。</p>

<h2>Lua的C接口交互</h2>

<p>Lua提供了C API，通过这些接口，Lua和C被连接起来，对Lua的操作就是靠这些C API，在C环境和Lua环境中间，有一个Lua栈，Lua与C的交互其实就是通过对这个Lua栈的操作来实现的</p>

<h2>开始Lua</h2>

<p>在<code>ViewController.h</code>中导入Lua的头文件</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
<span class="cp">#include &quot;lua.h&quot;</span>
<span class="cp">#include &quot;lualib.h&quot;</span>
<span class="cp">#include &quot;lauxlib.h&quot;</span>

<span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="bp">UIViewController</span>
<span class="p">{</span>
    <span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div>
<p>大家一定看到了<code>lua_State *L;</code>这个结构体变量，这个变量是干什么的呢，这是Lua的环境变量，所有的Lua操作，都是基于这个环境变量，类似于iOS绘图中的<code>context</code></p>

<p>添加Lua的初始化方法到<code>ViewController.m</code>得<code>ViewDidLoad</code>中</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c">    <span class="p">[</span><span class="nb">self</span> <span class="n">initLuaState</span><span class="p">];</span>
</code></pre></div>
<p>实现初始化方法</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initLuaState</span>
<span class="p">{</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span>
    <span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">lua_settop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>    
    <span class="n">err</span> <span class="o">=</span> <span class="n">luaL_loadstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;print(&quot;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">world</span><span class="s">&quot;)&quot;</span><span class="p">);</span>  
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;cannot compile lua file: %s&quot;</span><span class="p">,</span><span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;cannot run lua file: %s&quot;</span><span class="p">,</span><span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>来仔细看下这个初始化方法</p>

<p><code>L = luaL_newstate()</code> 这是初始化了一个Lua的环境变量，可以看到之后的Lua操作都需要这个环境变量，这里你看到方法的前缀是<code>luaL_</code>，标准库的API是以<code>lua_</code>为前缀的，而<code>luaL_</code>是标准库的扩展库，<code>luaL_</code>前缀的函数一定能用<code>lua_</code>前缀的函数来实现；</p>

<p><code>luaL_openlibs(L);</code> 这是加载所有的Lua库类</p>

<p><code>lua_settop(L, 0);</code> 这是将栈的栈顶索引设置为指定的数值(此处为0)，这个怎么理解，看下图</p>

<p><img src="../img/2015-01-30-Use_Lua_in_iOS/LuaStack.png" alt=""></p>

<p>Lua栈的栈顶索引为-1，依次往下；而栈底为1，依次往上，比如说，一个栈原来有6个元素，调用<code>lua_settop(L, index)</code>设置index为5，就是把栈从下往上第5个(也就是“abc”字符串)作为栈顶，那么也就是删掉&quot;111&quot;这个栈顶元素，这是相对于栈底元素设置的；如果是相对于栈顶元素，要实现同样的小刚，就要设置索引为-2，也相当于删除掉栈顶元素。</p>

<p>回到刚才，<code>lua_settop(L, 0);</code>就是将栈底( index = 1 )下面的索引( index = 0 )作为栈顶，那就相当于删除栈内所有内容，所以这个函数的作用就是<strong>清空栈内容</strong></p>

<p><code>luaL_loadstring(L, &quot;print(&quot;Hello, world&quot;)&quot;)</code> 很明显，就是立刻执行<code>&quot;print(&quot;Hello, world&quot;)&quot;</code>Lua命令</p>

<p>再次运行程序，结果会打印出<code>Hello, world</code></p>

<p>好，这是大家喜闻乐见的一串字符</p>

<p>继续，在<code>ViewController.m</code>写以下代码</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="kt">int</span> <span class="nf">cubeTarget_position</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cubeTarget</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cubeTarget</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>再看来下，<code>lua_pushnumber(L,a)</code>表示将变量<strong>a</strong>压入Lua栈，方法还返回了压入的数据数量</p>

<p>这个方法的目的很明显，现在我们有了能够通过stack将对象中心点位置传给Lua栈的函数，不过想要Lua脚本能够调用它，还需要将这个函数与Lua环境绑定起来，我们可以通过<code>luaL_register</code>函数，将一组方法与Lua绑定，那么，在<code>ViewController.m</code>中添加下面方法</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="k">const</span> <span class="k">struct</span> <span class="n">luaL_Reg</span> <span class="n">cubeLib</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;cubeP&quot;</span><span class="p">,</span> <span class="n">cubeTarget_position</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">luaopen_cubeLib</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">luaL_newlib</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">cubeLib</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>其中<code>luaL_Reg</code>类型的数组，包含一组函数，这个数组通过<code>luaL_newlib</code>将函数传递给了Lua，这样，Lua脚本就能识别这些&quot;注册&quot;了的函数，<code>luaopen_cubeLib</code>方法需要在run脚本前调用，我们可以在<code>initLuaState</code>方法中的<code>lua_settop(L,0)</code>下写上</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c">    <span class="n">luaopen_cubeLib</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
</code></pre></div>
<p>下面我们来创建一个lua脚本
<img src="../img/2015-01-30-Use_Lua_in_iOS/CreateLua-1.png" alt="">
<img src="../img/2015-01-30-Use_Lua_in_iOS/CreateLua-2.png" alt=""></p>

<p>编辑Lua脚本如下</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">function</span> <span class="n">print_cube_position</span><span class="p">()</span>

<span class="n">cube_x</span><span class="p">,</span> <span class="n">cube_y</span> <span class="o">=</span> <span class="n">cubeLib</span><span class="p">.</span><span class="n">cubeP</span><span class="p">()</span>

<span class="n">print</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;cube is at (%f, %f)&quot;</span><span class="p">,</span> <span class="n">cube_x</span><span class="p">,</span> <span class="n">cube_y</span><span class="p">))</span>

<span class="n">end</span>
</code></pre></div>
<p>现在需要用以下代码替换之前的<code>luaL_loadstring</code>内容(之前用来执行helloworld命令了)</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">NSString</span> <span class="o">*</span><span class="n">luaFilePath</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">pathForResource</span><span class="p">:</span><span class="s">@&quot;Script&quot;</span> <span class="nl">ofType</span><span class="p">:</span><span class="s">@&quot;lua&quot;</span><span class="p">];</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">luaL_loadfile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">[</span><span class="n">luaFilePath</span> <span class="nl">cStringUsingEncoding</span><span class="p">:[</span><span class="bp">NSString</span> <span class="n">defaultCStringEncoding</span><span class="p">]]);</span>
</code></pre></div>
<p>并且还要修改我们的run loop 方法</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">runLoop:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">cubeTarget</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionDown</span><span class="p">];</span>

    <span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;print_cube_position&quot;</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;run error: %s&quot;</span><span class="p">,</span>
                   <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>这里得<code>lua_getglobal(L, &quot;print_cube_position&quot;)</code>指的是将Lua脚本中的变量<code>print_cube_position</code>方法放到栈顶。</p>

<p><code>lua_pcall(L, 0, 0, 0)</code>则调用栈顶的函数。</p>

<p>运行，打印</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="n">cube</span> <span class="n">is</span> <span class="n">at</span> <span class="p">(</span><span class="mf">130.000000</span><span class="p">,</span> <span class="mf">120.000000</span><span class="p">)</span>
<span class="n">cube</span> <span class="n">is</span> <span class="n">at</span> <span class="p">(</span><span class="mf">130.000000</span><span class="p">,</span> <span class="mf">130.000000</span><span class="p">)</span>
<span class="n">cube</span> <span class="n">is</span> <span class="n">at</span> <span class="p">(</span><span class="mf">130.000000</span><span class="p">,</span> <span class="mf">140.000000</span><span class="p">)</span>
<span class="n">cube</span> <span class="n">is</span> <span class="n">at</span> <span class="p">(</span><span class="mf">130.000000</span><span class="p">,</span> <span class="mf">150.000000</span><span class="p">)</span>
<span class="n">cube</span> <span class="n">is</span> <span class="n">at</span> <span class="p">(</span><span class="mf">130.000000</span><span class="p">,</span> <span class="mf">160.000000</span><span class="p">)</span>
</code></pre></div>
<p>接下来，我们更进一步，添加如下方法到<code>ViewController.m</code>中,</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="kt">int</span> <span class="nf">go_right</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">CubeView</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="n">CubeView</span> <span class="o">*</span><span class="p">)(</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">[</span><span class="n">sc</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionRight</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">go_left</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">CubeView</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="n">CubeView</span> <span class="o">*</span><span class="p">)(</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">[</span><span class="n">sc</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionLeft</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">go_up</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">CubeView</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="n">CubeView</span> <span class="o">*</span><span class="p">)(</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">[</span><span class="n">sc</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionUp</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">go_down</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">CubeView</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="n">CubeView</span> <span class="o">*</span><span class="p">)(</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">[</span><span class="n">sc</span> <span class="nl">goDirection</span><span class="p">:</span><span class="n">DirectionDown</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_cube_position</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">){</span>
    <span class="n">CubeView</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">__bridge</span> <span class="n">CubeView</span> <span class="o">*</span><span class="p">)</span><span class="n">lua_touserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">sc</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">sc</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>这里我们用了新的lua方法<code>lua_touserdata</code>，它能够向Lua传递指针，这些指针是我们在OC中创建的。</p>

<p>下一步，将新写的方法加入到注册数组中去，并且都取好名字(取名字不容易)</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="k">const</span> <span class="k">struct</span> <span class="n">luaL_Reg</span> <span class="n">cubeLib</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;go_right&quot;</span><span class="p">,</span> <span class="n">go_right</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;go_left&quot;</span><span class="p">,</span> <span class="n">go_left</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;go_up&quot;</span><span class="p">,</span> <span class="n">go_up</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;go_down&quot;</span><span class="p">,</span> <span class="n">go_down</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;get_cube_Position&quot;</span><span class="p">,</span><span class="n">get_cube_position</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&quot;cubeP&quot;</span><span class="p">,</span> <span class="n">cubeTarget_position</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>在cubeTaregt下面新建一个<code>CubeView</code>对象</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="n">CubeView</span> <span class="o">*</span><span class="n">otherCube</span><span class="p">;</span>
</code></pre></div>
<p>在<code>ViewDidLoad</code>里初始化这个新的对象,给它加上拖拽手势</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="n">otherCube</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CubeView</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithFrame</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="nl">Speed</span><span class="p">:</span><span class="mi">10</span> <span class="nl">Name</span><span class="p">:</span><span class="s">@&quot;Other&quot;</span><span class="p">];</span>
<span class="p">[</span><span class="n">otherCube</span> <span class="nl">setBackgroundColor</span><span class="p">:[</span><span class="bp">UIColor</span> <span class="n">greenColor</span><span class="p">]];</span>
<span class="bp">UIPanGestureRecognizer</span> <span class="o">*</span><span class="n">panGesture</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIPanGestureRecognizer</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">panAction</span><span class="p">:)];</span>
<span class="p">[</span><span class="n">cubeTarget</span> <span class="nl">addGestureRecognizer</span><span class="p">:</span><span class="n">panGesture</span><span class="p">];</span>

<span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">otherCube</span><span class="p">];</span>
</code></pre></div><div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">panAction:</span><span class="p">(</span><span class="bp">UIPanGestureRecognizer</span> <span class="o">*</span><span class="p">)</span><span class="nv">recognizer</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">recognizer</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UIGestureRecognizerStateEnded</span> <span class="o">&amp;&amp;</span> <span class="n">recognizer</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UIGestureRecognizerStateFailed</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="bp">CGPoint</span> <span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">recognizer</span> <span class="nl">locationInView</span><span class="p">:</span><span class="n">recognizer</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">superview</span><span class="p">];</span>
        <span class="n">recognizer</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">location</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>新建一个Lua脚本<code>Chase.lua</code></p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">function</span> <span class="n">chase</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="n">cubeTarget_x</span><span class="p">,</span> <span class="n">cubeTarget_y</span> <span class="o">=</span> <span class="n">myLib</span><span class="p">.</span><span class="n">cubeP</span><span class="p">()</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">myLib</span><span class="p">.</span><span class="n">get_cube_Position</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cubeTarget_x</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="n">then</span>
        <span class="n">myLib</span><span class="p">.</span><span class="n">go_left</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">elseif</span> <span class="n">cubeTarget_x</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="n">then</span>
        <span class="n">myLib</span><span class="p">.</span><span class="n">go_right</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="n">cubeTarget_y</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="n">then</span>
        <span class="n">myLib</span><span class="p">.</span><span class="n">go_down</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">elseif</span> <span class="n">cubeTarget_y</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="n">then</span>
        <span class="n">myLib</span><span class="p">.</span><span class="n">go_up</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">end</span>

<span class="n">end</span>
</code></pre></div>
<p>修改<code>(void)initLuaState</code>方法</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c">    <span class="bp">NSString</span> <span class="o">*</span><span class="n">luaFilePath</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">pathForResource</span><span class="p">:</span><span class="s">@&quot;Chase&quot;</span> <span class="nl">ofType</span><span class="p">:</span><span class="s">@&quot;lua&quot;</span><span class="p">];</span>
</code></pre></div>
<p>修改<code>(void)runLoop:(id)sender</code>方法</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c">    <span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;chase&quot;</span><span class="p">);</span>
    <span class="n">lua_pushlightuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="k">__bridge</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">otherCube</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;run error: %s&quot;</span><span class="p">,</span>
                   <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>这里就使用了<code>lua_pushlightuserdata</code>来传数据.</p>

<p>运行，就会看到绿色方块会朝着紫色方块移动，当你拖拽紫色方块后，绿色方块也会改变方向，而这一系列行为逻辑并没有写在工程代码中，而是写在了Lua脚本中，而Lua脚本是可以通过网络下载进应用中，也就能够改变绿色方块的运行逻辑了</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/01/24/First_Day_Blog/" data-toggle="tooltip" data-placement="top" title="Blog新篇章">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'devshen'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            </div>
        </div>
    </div>

</article>

    

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/quan_shen">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/quan.shen.921">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/devshen">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; DevShen Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    

</body>

</html>
